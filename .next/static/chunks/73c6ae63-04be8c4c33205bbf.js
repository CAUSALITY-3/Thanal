"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[523],{83369:function(e,t,r){var n,s,a=r(39575),i=r(73255).Buffer,o=r(46004),c=r(33943),u=r(75312),p=r(81348),h=r(72738),d=r(1435),f=r(52539),l=r(41383),k=r(35901),y=r(81647),_=r(54958),b=r(55236),w=r(56948),m=["id_token_hint"],v=["initialAccessToken","jwks"];function x(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return g(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return g(e,t)}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,s=function(){};return{s:s,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:s}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){o=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(o)throw a}}}}function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function j(e,t,r){(function(e,t){if(t.has(e))throw TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,r)}function P(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function T(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?P(Object(r),!0).forEach(function(t){b(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):P(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var S=r(39527).inspect,E=r(12706),A=r(75103),O=r(1422).strict,J=r(80118),W=r(97179),R=r(97179),z=R.URL,C=R.URLSearchParams,q=r(1628),D=r(22611),M=r(30100),I=r(59130),B=r(78187),K=r(47534),N=r(33462),U=r(49677),H=U.assertSigningAlgValuesSupport,G=U.assertIssuerConfiguration,$=r(8e3),F=r(86314),L=r(36096),V=r(58967),Y=r(56918),Q=Y.OPError,X=Y.RPError,Z=r(69799),ee=r(2110).random,et=r(27789),er=r(33082).CLOCK_TOLERANCE,en=r(19127).keystores,es=r(9175),ea=r(99978),ei=r(96032),eo=ei.authenticatedPost,ec=ei.resolveResponseType,eu=ei.resolveRedirectUri,ep=r(35314).queryKeyStore,eh=r(20993),ed=w(a.version.slice(1).split(".").map(function(e){return parseInt(e,10)}),2),ef=ed[0],el=ed[1],ek=ef>=17||16===ef&&el>=9,ey=Symbol(),e_=Symbol(),eb=Symbol();function ew(e){return $(e,"access_token","code","error_description","error_uri","error","expires_in","id_token","iss","response","session_state","state","token_type")}function em(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Bearer";return"".concat(t," ").concat(e)}function ev(e){var t=W.parse(e);return t.search?J.parse(t.search.substring(1)):{}}function ex(e,t,r){if(void 0===e[r])throw new X({message:"missing required JWT property ".concat(r),jwt:t})}function eg(e){var t=T({client_id:this.client_id,scope:"openid",response_type:ec.call(this),redirect_uri:eu.call(this)},e);return Object.entries(t).forEach(function(e){var r=w(e,2),n=r[0],s=r[1];null==s?delete t[n]:"claims"===n&&"object"==typeof s?t[n]=JSON.stringify(s):"resource"===n&&Array.isArray(s)?t[n]=s:"string"!=typeof s&&(t[n]=String(s))}),t}function ej(e){if(!F(e)||!Array.isArray(e.keys)||e.keys.some(function(e){return!F(e)||!("kty"in e)}))throw TypeError("jwks must be a JSON Web Key Set formatted object");return es.fromJWKS(e,{onlyPrivate:!0})}var eP=new WeakMap,eT=new WeakMap,eS=new WeakMap,eE=new WeakMap;n=S.custom;var eA=function(){var e,t,r,o,c,u,b,g,P,R,U,$,Y,es,ei,ec,eu,ed,ef,el,ek,eA;function eO(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;if(l(this,eO),j(this,eP,{writable:!0,value:void 0}),j(this,eT,{writable:!0,value:void 0}),j(this,eS,{writable:!0,value:void 0}),j(this,eE,{writable:!0,value:void 0}),_(this,eP,new Map),_(this,eT,e),_(this,eS,t),"string"!=typeof n.client_id||!n.client_id)throw TypeError("client_id is required");var i=T(T({grant_types:["authorization_code"],id_token_signed_response_alg:"RS256",authorization_signed_response_alg:"RS256",response_types:["code"],token_endpoint_auth_method:"client_secret_basic"},this.fapi()?{grant_types:["authorization_code","implicit"],id_token_signed_response_alg:"PS256",authorization_signed_response_alg:"PS256",response_types:["code id_token"],tls_client_certificate_bound_access_tokens:!0,token_endpoint_auth_method:void 0}:void 0),n);if(this.fapi())switch(i.token_endpoint_auth_method){case"self_signed_tls_client_auth":case"tls_client_auth":break;case"private_key_jwt":if(!s)throw TypeError("jwks is required");break;case void 0:throw TypeError("token_endpoint_auth_method is required");default:throw TypeError("invalid or unsupported token_endpoint_auth_method")}if(!function(e,t,r){if(t.token_endpoint_auth_method||function(e,t){try{var r=e.issuer.token_endpoint_auth_methods_supported;!r.includes(t.token_endpoint_auth_method)&&r.includes("client_secret_post")&&(t.token_endpoint_auth_method="client_secret_post")}catch(e){}}(e,r),t.redirect_uri){if(t.redirect_uris)throw TypeError("provide a redirect_uri or redirect_uris, not both");r.redirect_uris=[t.redirect_uri],delete r.redirect_uri}if(t.response_type){if(t.response_types)throw TypeError("provide a response_type or response_types, not both");r.response_types=[t.response_type],delete r.response_type}}(this,n,i),H("token",this.issuer,i),["introspection","revocation"].forEach(function(e){(function(e,t,r){if(t["".concat(e,"_endpoint")]){var n=r.token_endpoint_auth_method,s=r.token_endpoint_auth_signing_alg,a="".concat(e,"_endpoint_auth_method"),i="".concat(e,"_endpoint_auth_signing_alg");void 0===r[a]&&void 0===r[i]&&(void 0!==n&&(r[a]=n),void 0!==s&&(r[i]=s))}})(e,r.issuer,i),H(e,r.issuer,i)}),Object.entries(i).forEach(function(e){var t=w(e,2),n=t[0],s=t[1];y(r,eP).set(n,s),r[n]||Object.defineProperty(r,n,{get:function(){return y(this,eP).get(n)},enumerable:!0})}),void 0!==s){var o=ej.call(this,s);en.set(this,o)}null!=a&&a.additionalAuthorizedParties&&_(this,eE,ea(a.additionalAuthorizedParties)),this[er]=0}return k(eO,[{key:"authorizationUrl",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!F(e))throw TypeError("params must be a plain object");G(this.issuer,"authorization_endpoint");for(var t=new z(this.issuer.authorization_endpoint),r=0,n=Object.entries(eg.call(this,e));r<n.length;r++){var s=w(n[r],2),a=s[0],i=s[1];if(Array.isArray(i)){t.searchParams.delete(a);var o,c=x(i);try{for(c.s();!(o=c.n()).done;){var u=o.value;t.searchParams.append(a,u)}}catch(e){c.e(e)}finally{c.f()}}else t.searchParams.set(a,i)}return t.href.replace(/\+/g,"%20")}},{key:"authorizationPost",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!F(e))throw TypeError("params must be a plain object");var t=eg.call(this,e),r=Object.keys(t).map(function(e){return'<input type="hidden" name="'.concat(e,'" value="').concat(t[e],'"/>')}).join("\n");return'<!DOCTYPE html>\n<head>\n<title>Requesting Authorization</title>\n</head>\n<body onload="javascript:document.forms[0].submit()">\n<form method="post" action="'.concat(this.issuer.authorization_endpoint,'">\n  ').concat(r,"\n</form>\n</body>\n</html>")}},{key:"endSessionUrl",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};G(this.issuer,"end_session_endpoint");var r=this.post_logout_redirect_uris||[],n=r[0],s=r.length,a=t.post_logout_redirect_uri,i=t;if(e=i.id_token_hint,t=f(i,m),e instanceof V){if(!e.id_token)throw TypeError("id_token not present in TokenSet");e=e.id_token}var o=W.parse(this.issuer.end_session_endpoint),c=K(ev(this.issuer.end_session_endpoint),t,{post_logout_redirect_uri:void 0===a?1===s?n:void 0:a,client_id:this.client_id},{id_token_hint:e});return Object.entries(c).forEach(function(e){var t=w(e,2),r=t[0];null==t[1]&&delete c[r]}),o.search=null,o.query=c,W.format(o)}},{key:"callbackParams",value:function(e){var t=e instanceof E.IncomingMessage||e&&e.method&&e.url;if("string"!=typeof e&&!t)throw TypeError("#callbackParams only accepts string urls, http.IncomingMessage or a lookalike");if(!t)return ew(ev(e));switch(e.method){case"GET":return ew(ev(e.url));case"POST":if(void 0===e.body)throw TypeError("incoming message body missing, include a body parser prior to this method call");switch(typeof e.body){case"object":case"string":if(i.isBuffer(e.body))return ew(J.parse(e.body.toString("utf-8")));if("string"==typeof e.body)return ew(J.parse(e.body));return ew(e.body);default:throw TypeError("invalid IncomingMessage body object")}default:throw TypeError("invalid IncomingMessage method")}}},{key:"callback",value:(e=d(h.mark(function e(t,r){var n,s,a,i,o,c,u,p,d,f,l,k,y,_,b,w,m=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=m.length>2&&void 0!==m[2]?m[2]:{},a=(s=m.length>3&&void 0!==m[3]?m[3]:{}).exchangeBody,i=s.clientAssertionPayload,o=s.DPoP,c=ew(r),!(n.jarm&&!("response"in r))){e.next=7;break}throw new X({message:"expected a JARM response",checks:n,params:c});case 7:if(!("response"in r)){e.next=14;break}return e.next=10,this.decryptJARM(c.response);case 10:return u=e.sent,e.next=13,this.validateJARM(u);case 13:c=e.sent;case 14:if(this.default_max_age&&!n.max_age&&(n.max_age=this.default_max_age),!(c.state&&!n.state)){e.next=17;break}throw TypeError("checks.state argument is missing");case 17:if(!(!c.state&&n.state)){e.next=19;break}throw new X({message:"state missing from the response",checks:n,params:c});case 19:if(!(n.state!==c.state)){e.next=21;break}throw new X({printf:["state mismatch, expected %s, got: %s",n.state,c.state],checks:n,params:c});case 21:if(!("iss"in c)){e.next=27;break}if(G(this.issuer,"issuer"),!(c.iss!==this.issuer.issuer)){e.next=25;break}throw new X({printf:["iss mismatch, expected %s, got: %s",this.issuer.issuer,c.iss],params:c});case 25:e.next=29;break;case 27:if(!(this.issuer.authorization_response_iss_parameter_supported&&!("id_token"in c)&&!("response"in r))){e.next=29;break}throw new X({message:"iss missing from the response",params:c});case 29:if(!c.error){e.next=31;break}throw new Q(c);case 31:if(p={code:["code"],id_token:["id_token"],token:["access_token","token_type"]},!n.response_type){e.next=70;break}d=x(n.response_type.split(" ")),e.prev=34,d.s();case 36:if((f=d.n()).done){e.next=62;break}if("none"!==(l=f.value)){e.next=43;break}if(!(c.code||c.id_token||c.access_token)){e.next=41;break}throw new X({message:'unexpected params encountered for "none" response',checks:n,params:c});case 41:e.next=60;break;case 43:k=x(p[l]),e.prev=44,k.s();case 46:if((y=k.n()).done){e.next=52;break}if(c[_=y.value]){e.next=50;break}throw new X({message:"".concat(_," missing from response"),checks:n,params:c});case 50:e.next=46;break;case 52:e.next=57;break;case 54:e.prev=54,e.t0=e.catch(44),k.e(e.t0);case 57:return e.prev=57,k.f(),e.finish(57);case 60:e.next=36;break;case 62:e.next=67;break;case 64:e.prev=64,e.t1=e.catch(34),d.e(e.t1);case 67:return e.prev=67,d.f(),e.finish(67);case 70:if(!c.id_token){e.next=78;break}return b=new V(c),e.next=74,this.decryptIdToken(b);case 74:return e.next=76,this.validateIdToken(b,n.nonce,"authorization",n.max_age,n.state);case 76:if(c.code){e.next=78;break}return e.abrupt("return",b);case 78:if(!c.code){e.next=88;break}return e.next=81,this.grant(T(T({},a),{},{grant_type:"authorization_code",code:c.code,redirect_uri:t,code_verifier:n.code_verifier}),{clientAssertionPayload:i,DPoP:o});case 81:return w=e.sent,e.next=84,this.decryptIdToken(w);case 84:return e.next=86,this.validateIdToken(w,n.nonce,"token",n.max_age);case 86:return c.session_state&&(w.session_state=c.session_state),e.abrupt("return",w);case 88:return e.abrupt("return",new V(c));case 89:case"end":return e.stop()}},e,this,[[34,64,67,70],[44,54,57,60]])})),function(t,r){return e.apply(this,arguments)})},{key:"oauthCallback",value:(t=d(h.mark(function e(t,r){var n,s,a,i,o,c,u,p,d,f,l,k,y,_,b,w=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=w.length>2&&void 0!==w[2]?w[2]:{},a=(s=w.length>3&&void 0!==w[3]?w[3]:{}).exchangeBody,i=s.clientAssertionPayload,o=s.DPoP,c=ew(r),!(n.jarm&&!("response"in r))){e.next=7;break}throw new X({message:"expected a JARM response",checks:n,params:c});case 7:if(!("response"in r)){e.next=14;break}return e.next=10,this.decryptJARM(c.response);case 10:return u=e.sent,e.next=13,this.validateJARM(u);case 13:c=e.sent;case 14:if(!(c.state&&!n.state)){e.next=16;break}throw TypeError("checks.state argument is missing");case 16:if(!(!c.state&&n.state)){e.next=18;break}throw new X({message:"state missing from the response",checks:n,params:c});case 18:if(!(n.state!==c.state)){e.next=20;break}throw new X({printf:["state mismatch, expected %s, got: %s",n.state,c.state],checks:n,params:c});case 20:if(!("iss"in c)){e.next=26;break}if(G(this.issuer,"issuer"),!(c.iss!==this.issuer.issuer)){e.next=24;break}throw new X({printf:["iss mismatch, expected %s, got: %s",this.issuer.issuer,c.iss],params:c});case 24:e.next=28;break;case 26:if(!(this.issuer.authorization_response_iss_parameter_supported&&!("id_token"in c)&&!("response"in r))){e.next=28;break}throw new X({message:"iss missing from the response",params:c});case 28:if(!c.error){e.next=30;break}throw new Q(c);case 30:if(!("string"==typeof c.id_token&&c.id_token.length)){e.next=32;break}throw new X({message:"id_token detected in the response, you must use client.callback() instead of client.oauthCallback()",params:c});case 32:if(delete c.id_token,p={code:["code"],token:["access_token","token_type"]},!n.response_type){e.next=71;break}d=x(n.response_type.split(" ")),e.prev=36,d.s();case 38:if((f=d.n()).done){e.next=63;break}if("none"!==(l=f.value)||!(c.code||c.id_token||c.access_token)){e.next=43;break}throw new X({message:'unexpected params encountered for "none" response',checks:n,params:c});case 43:if(!p[l]){e.next=61;break}k=x(p[l]),e.prev=45,k.s();case 47:if((y=k.n()).done){e.next=53;break}if(c[_=y.value]){e.next=51;break}throw new X({message:"".concat(_," missing from response"),checks:n,params:c});case 51:e.next=47;break;case 53:e.next=58;break;case 55:e.prev=55,e.t0=e.catch(45),k.e(e.t0);case 58:return e.prev=58,k.f(),e.finish(58);case 61:e.next=38;break;case 63:e.next=68;break;case 65:e.prev=65,e.t1=e.catch(36),d.e(e.t1);case 68:return e.prev=68,d.f(),e.finish(68);case 71:if(!c.code){e.next=79;break}return e.next=74,this.grant(T(T({},a),{},{grant_type:"authorization_code",code:c.code,redirect_uri:t,code_verifier:n.code_verifier}),{clientAssertionPayload:i,DPoP:o});case 74:if(!("string"==typeof(b=e.sent).id_token&&b.id_token.length)){e.next=77;break}throw new X({message:"id_token detected in the response, you must use client.callback() instead of client.oauthCallback()",params:c});case 77:return delete b.id_token,e.abrupt("return",b);case 79:return e.abrupt("return",new V(c));case 80:case"end":return e.stop()}},e,this,[[36,65,68,71],[45,55,58,61]])})),function(e,r){return t.apply(this,arguments)})},{key:"decryptIdToken",value:(r=d(h.mark(function e(t){var r,n,s,a;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.id_token_encrypted_response_alg){e.next=2;break}return e.abrupt("return",t);case 2:if(!((r=t)instanceof V)){e.next=7;break}if(r.id_token){e.next=6;break}throw TypeError("id_token not present in TokenSet");case 6:r=r.id_token;case 7:return n=this.id_token_encrypted_response_alg,s=this.id_token_encrypted_response_enc,e.next=11,this.decryptJWE(r,n,s);case 11:if(a=e.sent,!(t instanceof V)){e.next=15;break}return t.id_token=a,e.abrupt("return",t);case 15:return e.abrupt("return",a);case 16:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"validateJWTUserinfo",value:(o=d(h.mark(function e(t){var r;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.userinfo_signed_response_alg,e.abrupt("return",this.validateJWT(t,r,[]));case 2:case"end":return e.stop()}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"decryptJARM",value:(c=d(h.mark(function e(t){var r,n;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.authorization_encrypted_response_alg){e.next=2;break}return e.abrupt("return",t);case 2:return r=this.authorization_encrypted_response_alg,n=this.authorization_encrypted_response_enc,e.abrupt("return",this.decryptJWE(t,r,n));case 5:case"end":return e.stop()}},e,this)})),function(e){return c.apply(this,arguments)})},{key:"decryptJWTUserinfo",value:(u=d(h.mark(function e(t){var r,n;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.userinfo_encrypted_response_alg){e.next=2;break}return e.abrupt("return",t);case 2:return r=this.userinfo_encrypted_response_alg,n=this.userinfo_encrypted_response_enc,e.abrupt("return",this.decryptJWE(t,r,n));case 5:case"end":return e.stop()}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"decryptJWE",value:(b=d(h.mark(function e(t,r){var n,s,a,i,o,c,u,p,d,f=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=f.length>2&&void 0!==f[2]?f[2]:"A128CBC-HS256",!((s=JSON.parse(B.decode(t.split(".")[0]))).alg!==r)){e.next=4;break}throw new X({printf:["unexpected JWE alg received, expected %s, got: %s",r,s.alg],jwt:t});case 4:if(!(s.enc!==n)){e.next=6;break}throw new X({printf:["unexpected JWE enc received, expected %s, got: %s",n,s.enc],jwt:t});case 6:if(a=function(e){return new TextDecoder().decode(e.plaintext)},!r.match(/^(?:RSA|ECDH)/)){e.next=39;break}return e.next=10,en.get(this);case 10:o=e.sent,c=q.decodeProtectedHeader(t),u=x(o.all(T(T({},c),{},{use:"enc"}))),e.prev=13,u.s();case 15:if((p=u.n()).done){e.next=29;break}return d=p.value,e.t0=q,e.t1=t,e.next=21,d.keyObject(c.alg);case 21:return e.t2=e.sent,e.next=24,e.t0.compactDecrypt.call(e.t0,e.t1,e.t2).then(a,function(){});case 24:if(!(i=e.sent)){e.next=27;break}return e.abrupt("break",29);case 27:e.next=15;break;case 29:e.next=34;break;case 31:e.prev=31,e.t3=e.catch(13),u.e(e.t3);case 34:return e.prev=34,u.f(),e.finish(34);case 37:e.next=42;break;case 39:return e.next=41,q.compactDecrypt(t,this.secretForAlg("dir"===r?n:r)).then(a,function(){});case 41:i=e.sent;case 42:if(i){e.next=44;break}throw new X({message:"failed to decrypt JWE",jwt:t});case 44:return e.abrupt("return",i);case 45:case"end":return e.stop()}},e,this,[[13,31,34,37]])})),function(e,t){return b.apply(this,arguments)})},{key:"validateIdToken",value:(g=d(h.mark(function e(t,r,n,s,a){var i,o,c,u,p,d,f;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t,o=this.id_token_signed_response_alg,!(i instanceof V)){e.next=7;break}if(i.id_token){e.next=6;break}throw TypeError("id_token not present in TokenSet");case 6:i=i.id_token;case 7:return i=String(i),c=Z(),e.next=11,this.validateJWT(i,o);case 11:if(p=(u=e.sent).protected,d=u.payload,f=u.key,!("number"==typeof s||s!==eb&&this.require_auth_time)){e.next=20;break}if(d.auth_time){e.next=18;break}throw new X({message:"missing required JWT property auth_time",jwt:i});case 18:if(!("number"!=typeof d.auth_time)){e.next=20;break}throw new X({message:"JWT auth_time claim must be a JSON numeric value",jwt:i});case 20:if(!("number"==typeof s&&d.auth_time+s<c-this[er])){e.next=22;break}throw new X({printf:["too much time has elapsed since the last End-User authentication, max_age %i, auth_time: %i, now %i",s,d.auth_time,c-this[er]],now:c,tolerance:this[er],auth_time:d.auth_time,jwt:i});case 22:if(!(r!==e_&&(d.nonce||void 0!==r)&&d.nonce!==r)){e.next=24;break}throw new X({printf:["nonce mismatch, expected %s, got: %s",r,d.nonce],jwt:i});case 24:if("authorization"!==n){e.next=42;break}if(!(!d.at_hash&&t.access_token)){e.next=27;break}throw new X({message:"missing required property at_hash",jwt:i});case 27:if(!(!d.c_hash&&t.code)){e.next=29;break}throw new X({message:"missing required property c_hash",jwt:i});case 29:if(!this.fapi()||!(!d.s_hash&&(t.state||a))){e.next=32;break}throw new X({message:"missing required property s_hash",jwt:i});case 32:if(!d.s_hash){e.next=42;break}if(a){e.next=35;break}throw TypeError('cannot verify s_hash, "checks.state" property not provided');case 35:e.prev=35,D.validate({claim:"s_hash",source:"state"},d.s_hash,a,p.alg,f.jwk&&f.jwk.crv),e.next=42;break;case 39:throw e.prev=39,e.t0=e.catch(35),new X({message:e.t0.message,jwt:i});case 42:if(!(this.fapi()&&d.iat<c-3600)){e.next=44;break}throw new X({printf:["JWT issued too far in the past, now %i, iat %i",c,d.iat],now:c,tolerance:this[er],iat:d.iat,jwt:i});case 44:if(!(t.access_token&&void 0!==d.at_hash)){e.next=52;break}e.prev=45,D.validate({claim:"at_hash",source:"access_token"},d.at_hash,t.access_token,p.alg,f.jwk&&f.jwk.crv),e.next=52;break;case 49:throw e.prev=49,e.t1=e.catch(45),new X({message:e.t1.message,jwt:i});case 52:if(!(t.code&&void 0!==d.c_hash)){e.next=60;break}e.prev=53,D.validate({claim:"c_hash",source:"code"},d.c_hash,t.code,p.alg,f.jwk&&f.jwk.crv),e.next=60;break;case 57:throw e.prev=57,e.t2=e.catch(53),new X({message:e.t2.message,jwt:i});case 60:return e.abrupt("return",t);case 61:case"end":return e.stop()}},e,this,[[35,39],[45,49],[53,57]])})),function(e,t,r,n,s){return g.apply(this,arguments)})},{key:"validateJWT",value:(P=d(h.mark(function e(t,r){var n,s,a,i,o,c,u,d,f,l,k,_,b,w,m=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=m.length>2&&void 0!==m[2]?m[2]:["iss","sub","aud","exp","iat"],s="https://self-issued.me"===this.issuer.issuer,a=Z(),e.prev=3,i=(c=I(t,{complete:!0})).header,o=c.payload,e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(3),new X({printf:["failed to decode JWT (%s: %s)",e.t0.name,e.t0.message],jwt:t});case 12:if(!(i.alg!==r)){e.next=14;break}throw new X({printf:["unexpected JWT alg received, expected %s, got: %s",r,i.alg],jwt:t});case 14:if(s&&(n=[].concat(p(n),["sub_jwk"])),n.forEach(ex.bind(void 0,o,t)),!(void 0!==o.iss)||(u=this.issuer.issuer,y(this,eS)&&(u=this.issuer.issuer.replace("{tenantid}",o.tid)),!(o.iss!==u))){e.next=21;break}throw new X({printf:["unexpected iss value, expected %s, got: %s",u,o.iss],jwt:t});case 21:if(!(void 0!==o.iat)||!("number"!=typeof o.iat)){e.next=24;break}throw new X({message:"JWT iat claim must be a JSON numeric value",jwt:t});case 24:if(!(void 0!==o.nbf)){e.next=29;break}if(!("number"!=typeof o.nbf)){e.next=27;break}throw new X({message:"JWT nbf claim must be a JSON numeric value",jwt:t});case 27:if(!(o.nbf>a+this[er])){e.next=29;break}throw new X({printf:["JWT not active yet, now %i, nbf %i",a+this[er],o.nbf],now:a,tolerance:this[er],nbf:o.nbf,jwt:t});case 29:if(!(void 0!==o.exp)){e.next=34;break}if(!("number"!=typeof o.exp)){e.next=32;break}throw new X({message:"JWT exp claim must be a JSON numeric value",jwt:t});case 32:if(!(a-this[er]>=o.exp)){e.next=34;break}throw new X({printf:["JWT expired, now %i, exp %i",a-this[er],o.exp],now:a,tolerance:this[er],exp:o.exp,jwt:t});case 34:if(!(void 0!==o.aud)){e.next=44;break}if(!Array.isArray(o.aud)){e.next=42;break}if(!(o.aud.length>1&&!o.azp)){e.next=38;break}throw new X({message:"missing required JWT property azp",jwt:t});case 38:if(o.aud.includes(this.client_id)){e.next=40;break}throw new X({printf:["aud is missing the client_id, expected %s to be included in %j",this.client_id,o.aud],jwt:t});case 40:e.next=44;break;case 42:if(!(o.aud!==this.client_id)){e.next=44;break}throw new X({printf:["aud mismatch, expected %s, got: %s",this.client_id,o.aud],jwt:t});case 44:if(!(void 0!==o.azp)||(d="string"==typeof(d=y(this,eE))?[this.client_id,d]:Array.isArray(d)?[this.client_id].concat(p(d)):[this.client_id]).includes(o.azp)){e.next=49;break}throw new X({printf:["azp mismatch, got: %s",o.azp],jwt:t});case 49:if(!s){e.next=70;break}return e.prev=50,O(F(o.sub_jwk)),e.next=54,q.importJWK(o.sub_jwk,i.alg);case 54:l=e.sent,O.equal(l.type,"public"),f=[{keyObject:function(){return l}}],e.next=62;break;case 59:throw e.prev=59,e.t1=e.catch(50),new X({message:"failed to use sub_jwk claim as an asymmetric JSON Web Key",jwt:t});case 62:return e.next=64,q.calculateJwkThumbprint(o.sub_jwk);case 64:if(e.t2=e.sent,e.t3=o.sub,!(e.t2!==e.t3)){e.next=68;break}throw new X({message:"failed to match the subject with sub_jwk",jwt:t});case 68:e.next=78;break;case 70:if(!i.alg.startsWith("HS")){e.next=74;break}f=[this.secretForAlg(i.alg)],e.next=78;break;case 74:if(!("none"!==i.alg)){e.next=78;break}return e.next=77,ep.call(this.issuer,T(T({},i),{},{use:"sig"}));case 77:f=e.sent;case 78:if(!(!f&&"none"===i.alg)){e.next=80;break}return e.abrupt("return",{protected:i,payload:o});case 80:k=x(f),e.prev=81,k.s();case 83:if((_=k.n()).done){e.next=102;break}if(b=_.value,e.t4=q,e.t5=t,!(b instanceof Uint8Array)){e.next=91;break}e.t6=b,e.next=94;break;case 91:return e.next=93,b.keyObject(i.alg);case 93:e.t6=e.sent;case 94:return e.t7=e.t6,e.next=97,e.t4.compactVerify.call(e.t4,e.t5,e.t7).catch(function(){});case 97:if(!(w=e.sent)){e.next=100;break}return e.abrupt("return",{payload:o,protected:w.protectedHeader,key:b});case 100:e.next=83;break;case 102:e.next=107;break;case 104:e.prev=104,e.t8=e.catch(81),k.e(e.t8);case 107:return e.prev=107,k.f(),e.finish(107);case 110:throw new X({message:"failed to validate JWT signature",jwt:t});case 111:case"end":return e.stop()}},e,this,[[3,9],[50,59],[81,104,107,110]])})),function(e,t){return P.apply(this,arguments)})},{key:"refresh",value:(R=d(h.mark(function e(t){var r,n,s,a,i,o,c,u,p=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(r=p.length>1&&void 0!==p[1]?p[1]:{}).exchangeBody,s=r.clientAssertionPayload,a=r.DPoP,!((i=t)instanceof V)){e.next=6;break}if(i.refresh_token){e.next=5;break}throw TypeError("refresh_token not present in TokenSet");case 5:i=i.refresh_token;case 6:return e.next=8,this.grant(T(T({},n),{},{grant_type:"refresh_token",refresh_token:String(i)}),{clientAssertionPayload:s,DPoP:a});case 8:if(!(o=e.sent).id_token){e.next=19;break}return e.next=12,this.decryptIdToken(o);case 12:return e.next=14,this.validateIdToken(o,e_,"token",eb);case 14:if(!(t instanceof V&&t.id_token)||(c=t.claims().sub,!((u=o.claims().sub)!==c))){e.next=19;break}throw new X({printf:["sub mismatch, expected %s, got: %s",c,u],jwt:o.id_token});case 19:return e.abrupt("return",o);case 20:case"end":return e.stop()}},e,this)})),function(e){return R.apply(this,arguments)})},{key:"requestResource",value:(U=d(h.mark(function e(t,r){var n,s,a,i,o,c,u,p,d,f,l,k,y=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=(n=y.length>2&&void 0!==y[2]?y[2]:{}).method,a=n.headers,i=n.body,o=n.DPoP,u=void 0===(c=n.tokenType)?o?"DPoP":r instanceof V?r.token_type:"Bearer":c,p=y.length>3?y[3]:void 0,!(r instanceof V)){e.next=6;break}if(r.access_token){e.next=5;break}throw TypeError("access_token not present in TokenSet");case 5:r=r.access_token;case 6:if(r){e.next=10;break}throw TypeError("no access token provided");case 10:if(!("string"!=typeof r)){e.next=12;break}throw TypeError("invalid access token provided");case 12:return d={headers:T({Authorization:em(r,u)},a),body:i},f=!!this.tls_client_certificate_bound_access_tokens,e.next=16,et.call(this,T(T({},d),{},{responseType:"buffer",method:s,url:t}),{accessToken:r,mTLS:f,DPoP:o});case 16:if(k=(l=e.sent).headers["www-authenticate"],!(p!==ey&&k&&k.toLowerCase().startsWith("dpop ")&&"use_dpop_nonce"===N(k).error)){e.next=20;break}return e.abrupt("return",this.requestResource(t,r,{method:s,headers:a,body:i,DPoP:o,tokenType:u}));case 20:return e.abrupt("return",l);case 21:case"end":return e.stop()}},e,this)})),function(e,t){return U.apply(this,arguments)})},{key:"userinfo",value:($=d(h.mark(function e(t){var r,n,s,a,i,o,c,u,p,d,f,l,k,y,_,b,m=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=void 0===(n=(r=m.length>1&&void 0!==m[1]?m[1]:{}).method)?"GET":n,i=void 0===(a=r.via)?"header":a,o=r.tokenType,c=r.params,u=r.DPoP,G(this.issuer,"userinfo_endpoint"),!("GET"!==(p={tokenType:o,method:String(s).toUpperCase(),DPoP:u}).method&&"POST"!==p.method)){e.next=5;break}throw TypeError("#userinfo() method can only be POST or a GET");case 5:if(!("body"===i&&"POST"!==p.method)){e.next=7;break}throw TypeError("can only send body on POST");case 7:return(d=!!(this.userinfo_signed_response_alg||this.userinfo_encrypted_response_alg))?p.headers={Accept:"application/jwt"}:p.headers={Accept:"application/json"},this.tls_client_certificate_bound_access_tokens&&this.issuer.mtls_endpoint_aliases&&(f=this.issuer.mtls_endpoint_aliases.userinfo_endpoint),f=new z(f||this.issuer.userinfo_endpoint),"body"===i&&(p.headers.Authorization=void 0,p.headers["Content-Type"]="application/x-www-form-urlencoded",p.body=new C,p.body.append("access_token",t instanceof V?t.access_token:t)),c&&("GET"===p.method?Object.entries(c).forEach(function(e){var t=w(e,2),r=t[0],n=t[1];f.searchParams.append(r,n)}):p.body?Object.entries(c).forEach(function(e){var t=w(e,2),r=t[0],n=t[1];p.body.append(r,n)}):(p.body=new C,p.headers["Content-Type"]="application/x-www-form-urlencoded",Object.entries(c).forEach(function(e){var t=w(e,2),r=t[0],n=t[1];p.body.append(r,n)}))),p.body&&(p.body=p.body.toString()),e.next=17,this.requestResource(f,t,p);case 17:if(k=L(l=e.sent,{bearer:!0}),!d){e.next=43;break}if(/^application\/jwt/.test(l.headers["content-type"])){e.next=22;break}throw new X({message:"expected application/jwt response from the userinfo_endpoint",response:l});case 22:return y=l.body.toString(),e.next=25,this.decryptJWTUserinfo(y);case 25:if(_=e.sent,this.userinfo_signed_response_alg){e.next=37;break}e.prev=27,O(F(k=JSON.parse(_))),e.next=35;break;case 32:throw e.prev=32,e.t0=e.catch(27),new X({message:"failed to parse userinfo JWE payload as JSON",jwt:_});case 35:e.next=41;break;case 37:return e.next=39,this.validateJWTUserinfo(_);case 39:k=e.sent.payload;case 41:e.next=51;break;case 43:e.prev=43,k=JSON.parse(l.body),e.next=51;break;case 47:throw e.prev=47,e.t1=e.catch(43),Object.defineProperty(e.t1,"response",{value:l}),e.t1;case 51:if(!(t instanceof V&&t.id_token)||(b=t.claims().sub,!(k.sub!==b))){e.next=55;break}throw new X({printf:["userinfo sub mismatch, expected %s, got: %s",b,k.sub],body:k,jwt:t.id_token});case 55:return e.abrupt("return",k);case 56:case"end":return e.stop()}},e,this,[[27,32],[43,47]])})),function(e){return $.apply(this,arguments)})},{key:"encryptionSecret",value:function(e){var t=e<=256?"sha256":e<=384?"sha384":e<=512&&"sha512";if(!t)throw Error("unsupported symmetric encryption key derivation");return A.createHash(t).update(this.client_secret).digest().slice(0,e/8)}},{key:"secretForAlg",value:function(e){if(!this.client_secret)throw TypeError("client_secret is required");return/^A(\d{3})(?:GCM)?KW$/.test(e)?this.encryptionSecret(parseInt(RegExp.$1,10)):/^A(\d{3})(?:GCM|CBC-HS(\d{3}))$/.test(e)?this.encryptionSecret(parseInt(RegExp.$2||RegExp.$1,10)):new TextEncoder().encode(this.client_secret)}},{key:"grant",value:(Y=d(h.mark(function e(t){var r,n,s,a,i,o,c=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(r=c.length>1&&void 0!==c[1]?c[1]:{}).clientAssertionPayload,s=r.DPoP,a=c.length>2?c[2]:void 0,G(this.issuer,"token_endpoint"),e.next=5,eo.call(this,"token",{form:t,responseType:"json"},{clientAssertionPayload:n,DPoP:s});case 5:i=e.sent,e.prev=6,o=L(i),e.next=15;break;case 10:if(e.prev=10,e.t0=e.catch(6),!(a!==ey&&e.t0 instanceof Q&&"use_dpop_nonce"===e.t0.error)){e.next=14;break}return e.abrupt("return",this.grant(t,{clientAssertionPayload:n,DPoP:s},ey));case 14:throw e.t0;case 15:return e.abrupt("return",new V(o));case 16:case"end":return e.stop()}},e,this,[[6,10]])})),function(e){return Y.apply(this,arguments)})},{key:"deviceAuthorization",value:(es=d(h.mark(function e(){var t,r,n,s,a,i,o,c=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=c.length>0&&void 0!==c[0]?c[0]:{},n=(r=c.length>1&&void 0!==c[1]?c[1]:{}).exchangeBody,s=r.clientAssertionPayload,a=r.DPoP,G(this.issuer,"device_authorization_endpoint"),G(this.issuer,"token_endpoint"),i=eg.call(this,T({client_id:this.client_id,redirect_uri:null,response_type:null},t)),e.next=7,eo.call(this,"device_authorization",{responseType:"json",form:i},{clientAssertionPayload:s,endpointAuthMethod:"token"});case 7:return o=L(e.sent),e.abrupt("return",new eh({client:this,exchangeBody:n,clientAssertionPayload:s,response:o,maxAge:t.max_age,DPoP:a}));case 10:case"end":return e.stop()}},e,this)})),function(){return es.apply(this,arguments)})},{key:"revoke",value:(ei=d(h.mark(function e(t,r){var n,s,a,i,o=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=(n=o.length>2&&void 0!==o[2]?o[2]:{}).revokeBody,a=n.clientAssertionPayload,G(this.issuer,"revocation_endpoint"),!(void 0!==r&&"string"!=typeof r)){e.next=4;break}throw TypeError("hint must be a string");case 4:return i=T(T({},s),{},{token:t}),r&&(i.token_type_hint=r),e.next=8,eo.call(this,"revocation",{form:i},{clientAssertionPayload:a});case 8:L(e.sent,{body:!1});case 10:case"end":return e.stop()}},e,this)})),function(e,t){return ei.apply(this,arguments)})},{key:"introspect",value:(ec=d(h.mark(function e(t,r){var n,s,a,i,o,c=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=(n=c.length>2&&void 0!==c[2]?c[2]:{}).introspectBody,a=n.clientAssertionPayload,G(this.issuer,"introspection_endpoint"),!(void 0!==r&&"string"!=typeof r)){e.next=4;break}throw TypeError("hint must be a string");case 4:return i=T(T({},s),{},{token:t}),r&&(i.token_type_hint=r),e.next=8,eo.call(this,"introspection",{form:i,responseType:"json"},{clientAssertionPayload:a});case 8:return o=L(e.sent),e.abrupt("return",o);case 11:case"end":return e.stop()}},e,this)})),function(e,t){return ec.apply(this,arguments)})},{key:"metadata",get:function(){return ea(Object.fromEntries(y(this,eP).entries()))}},{key:"requestObject",value:(eu=d(h.mark(function e(){var t,r,n,s,a,i,o,c,u,p,d,f,l,k,y,_,b,m,v=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=v.length>0&&void 0!==v[0]?v[0]:{},s=void 0===(n=(r=v.length>1&&void 0!==v[1]?v[1]:{}).sign)?this.request_object_signing_alg||"none":n,c=void 0===(o=(i=void 0===(a=r.encrypt)?{}:a).alg)?this.request_object_encryption_alg:o,p=void 0===(u=i.enc)?this.request_object_encryption_enc||"A128CBC-HS256":u,F(t)){e.next=4;break}throw TypeError("requestObject must be a plain object");case 4:if(l=Z(),k={alg:s,typ:"oauth-authz-req+jwt"},y=JSON.stringify(K({},t,T({iss:this.client_id,aud:this.issuer.issuer,client_id:this.client_id,jti:ee(),iat:l,exp:l+300},this.fapi()?{nbf:l}:void 0))),"none"!==s){e.next=11;break}d=[B.encode(JSON.stringify(k)),B.encode(y),""].join("."),e.next=36;break;case 11:if(!(_=s.startsWith("HS"))){e.next=16;break}f=this.secretForAlg(s),e.next=24;break;case 16:return e.next=18,en.get(this);case 18:if(b=e.sent){e.next=21;break}throw TypeError("no keystore present for client, cannot sign using alg ".concat(s));case 21:if(f=b.get({alg:s,use:"sig"})){e.next=24;break}throw TypeError("no key to sign with found for alg ".concat(s));case 24:if(e.t0=new q.CompactSign(new TextEncoder().encode(y)).setProtectedHeader(T(T({},k),{},{kid:_?void 0:f.jwk.kid})),!_){e.next=29;break}e.t1=f,e.next=32;break;case 29:return e.next=31,f.keyObject(s);case 31:e.t1=e.sent;case 32:return e.t2=e.t1,e.next=35,e.t0.sign.call(e.t0,e.t2);case 35:d=e.sent;case 36:if(c){e.next=38;break}return e.abrupt("return",d);case 38:if(!(m={alg:c,enc:p,cty:"oauth-authz-req+jwt"}).alg.match(/^(RSA|ECDH)/)){e.next=47;break}return e.next=42,ep.call(this.issuer,{alg:m.alg,use:"enc"},{allowMulti:!0});case 42:f=w(e.sent,1)[0],e.next=48;break;case 47:f=this.secretForAlg("dir"===m.alg?m.enc:m.alg);case 48:if(e.t3=new q.CompactEncrypt(new TextEncoder().encode(d)).setProtectedHeader(T(T({},m),{},{kid:f instanceof Uint8Array?void 0:f.jwk.kid})),!(f instanceof Uint8Array)){e.next=53;break}e.t4=f,e.next=56;break;case 53:return e.next=55,f.keyObject(m.alg);case 55:e.t4=e.sent;case 56:return e.t5=e.t4,e.abrupt("return",e.t3.encrypt.call(e.t3,e.t5));case 58:case"end":return e.stop()}},e,this)})),function(){return eu.apply(this,arguments)})},{key:"pushedAuthorizationRequest",value:(ed=d(h.mark(function e(){var t,r,n,s,a,i=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:{},r=(i.length>1&&void 0!==i[1]?i[1]:{}).clientAssertionPayload,G(this.issuer,"pushed_authorization_request_endpoint"),n=T(T({},"request"in t?t:eg.call(this,t)),{},{client_id:this.client_id}),e.next=6,eo.call(this,"pushed_authorization_request",{responseType:"json",form:n},{clientAssertionPayload:r,endpointAuthMethod:"token"});case 6:if("expires_in"in(a=L(s=e.sent,{statusCode:201}))){e.next=10;break}throw new X({message:"expected expires_in in Pushed Authorization Successful Response",response:s});case 10:if(!("number"!=typeof a.expires_in)){e.next=12;break}throw new X({message:"invalid expires_in value in Pushed Authorization Successful Response",response:s});case 12:if("request_uri"in a){e.next=14;break}throw new X({message:"expected request_uri in Pushed Authorization Successful Response",response:s});case 14:if(!("string"!=typeof a.request_uri)){e.next=16;break}throw new X({message:"invalid request_uri value in Pushed Authorization Successful Response",response:s});case 16:return e.abrupt("return",a);case 17:case"end":return e.stop()}},e,this)})),function(){return ed.apply(this,arguments)})},{key:"issuer",get:function(){return y(this,eT)}},{key:n,value:function(){return"".concat(this.constructor.name," ").concat(S(this.metadata,{depth:1/0,colors:a.stdout.isTTY,compact:!1,sorted:!0}))}},{key:"fapi",value:function(){return"FAPI1Client"===this.constructor.name}},{key:"validateJARM",value:(ef=d(h.mark(function e(t){var r,n;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.authorization_signed_response_alg,e.next=3,this.validateJWT(t,r,["iss","exp","aud"]);case 3:return n=e.sent.payload,e.abrupt("return",ew(n));case 6:case"end":return e.stop()}},e,this)})),function(e){return ef.apply(this,arguments)})},{key:"dpopProof",value:(el=d(h.mark(function e(t,r,n){var a,i;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(F(t)){e.next=2;break}throw TypeError("payload must be a plain object");case 2:if(!M(r)){e.next=6;break}a=r,e.next=15;break;case 6:if("CryptoKey"!==r[Symbol.toStringTag]){e.next=10;break}a=r,e.next=15;break;case 10:if("node:crypto"!==q.cryptoRuntime){e.next=14;break}a=A.createPrivateKey(r),e.next=15;break;case 14:throw TypeError("unrecognized crypto runtime");case 15:if(!("private"!==a.type)){e.next=17;break}throw TypeError('"DPoP" option must be a private key');case 17:if(i=s.call(this,a,r)){e.next=20;break}throw TypeError("could not determine DPoP JWS Algorithm");case 20:return e.t0=new q.SignJWT(T({ath:n?B.encode(A.createHash("sha256").update(n).digest()):void 0},t)),e.t1=i,e.next=24,function(e,t){return eI.apply(this,arguments)}(a,r);case 24:return e.t2=e.sent,e.t3={alg:e.t1,typ:"dpop+jwt",jwk:e.t2},e.abrupt("return",e.t0.setProtectedHeader.call(e.t0,e.t3).setIssuedAt().setJti(ee()).sign(a));case 27:case"end":return e.stop()}},e,this)})),function(e,t,r){return el.apply(this,arguments)})}],[{key:"register",value:(ek=d(h.mark(function e(t){var r,n,s,a,i,o,c=arguments;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(r=c.length>1&&void 0!==c[1]?c[1]:{}).initialAccessToken,s=r.jwks,a=f(r,v),G(this.issuer,"registration_endpoint"),!(void 0!==s&&!(t.jwks||t.jwks_uri))){e.next=8;break}return e.next=6,ej.call(this,s);case 6:i=e.sent,t.jwks=i.toJWKS();case 8:return e.next=10,et.call(this,{headers:T({Accept:"application/json"},n?{Authorization:em(n)}:void 0),responseType:"json",json:t,url:this.issuer.registration_endpoint,method:"POST"});case 10:return o=L(e.sent,{statusCode:201,bearer:!0}),e.abrupt("return",new this(o,s,a));case 13:case"end":return e.stop()}},e,this)})),function(e){return ek.apply(this,arguments)})},{key:"fromUri",value:(eA=d(h.mark(function e(t,r,n,s){var a;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,et.call(this,{method:"GET",url:t,responseType:"json",headers:{Authorization:em(r),Accept:"application/json"}});case 2:return a=L(e.sent,{bearer:!0}),e.abrupt("return",new this(a,n,s));case 5:case"end":return e.stop()}},e,this)})),function(e,t,r,n){return eA.apply(this,arguments)})}]),eO}();function eO(e){switch(e.algorithm.name){case"Ed25519":case"Ed448":return"EdDSA";case"ECDSA":switch(e.algorithm.namedCurve){case"P-256":return"ES256";case"P-384":return"ES384";case"P-521":return"ES512"}break;case"RSASSA-PKCS1-v1_5":return"RS".concat(e.algorithm.hash.name.slice(4));case"RSA-PSS":return"PS".concat(e.algorithm.hash.name.slice(4));default:throw TypeError("unsupported DPoP private key")}}if("node:crypto"===q.cryptoRuntime){var eJ=function(e,t,r){if("object"==typeof t&&"jwk"===t.format&&t.key&&t.key.alg)return t.key.alg;if(Array.isArray(r)){var n=r.filter(RegExp.prototype.test.bind(eR));return"rsa-pss"===e.asymmetricKeyType&&(n=n.filter(function(e){return e.startsWith("PS")})),["PS256","PS384","PS512","RS256","RS384","RS384"].find(function(e){return n.includes(e)})}return"PS256"},eW=function(e,t){switch("object"==typeof t&&"object"==typeof t.key&&t.key.crv){case"P-256":return"ES256";case"secp256k1":return"ES256K";case"P-384":return"ES384";case"P-512":return"ES512"}var r=e.export({format:"der",type:"pkcs8"}),n=r[1]<128?17:18,s=r[n],a=r.slice(n+1,n+1+s);if(a.equals(ez))return"ES256";if(a.equals(eC))return"ES384";if(a.equals(eq))return"ES512";if(a.equals(eD))return"ES256K";throw TypeError("unsupported DPoP private key curve")};s=function(e,t){if("CryptoKey"===t[Symbol.toStringTag])return eO(e);switch(e.asymmetricKeyType){case"ed25519":case"ed448":return"EdDSA";case"ec":return eW(e,t);case"rsa":case ek&&"rsa-pss":return eJ(e,t,this.issuer.dpop_signing_alg_values_supported);default:throw TypeError("unsupported DPoP private key")}};var eR=/^(?:RS|PS)(?:256|384|512)$/,ez=i.from([42,134,72,206,61,3,1,7]),eC=i.from([43,129,4,0,34]),eq=i.from([43,129,4,0,35]),eD=i.from([43,129,4,0,10])}else s=eO;var eM=new WeakMap;function eI(){return(eI=d(h.mark(function e(t,r){var n;return h.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!("node:crypto"===q.cryptoRuntime&&"object"==typeof r&&"object"==typeof r.key&&"jwk"===r.format)){e.next=2;break}return e.abrupt("return",$(r.key,"kty","crv","x","y","e","n"));case 2:if(!eM.has(r)){e.next=4;break}return e.abrupt("return",eM.get(r));case 4:return e.t0=$,e.next=7,q.exportJWK(t);case 7:return e.t1=e.sent,n=(0,e.t0)(e.t1,"kty","crv","x","y","e","n"),(M(r)||"WebCryptoAPI"===q.cryptoRuntime)&&eM.set(r,n),e.abrupt("return",n);case 11:case"end":return e.stop()}},e)}))).apply(this,arguments)}e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(r){o(a,r);var n,s=(n=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=u(a);if(n){var r=u(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return c(this,e)});function a(){l(this,a);for(var r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return s.call.apply(s,[this,e,t].concat(n))}return k(a,null,[{key:"issuer",get:function(){return e}}]),a}(eA)},e.exports.BaseClient=eA}}]);